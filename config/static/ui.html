<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>HelixRun Credentials</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <style>
        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #020617;
            color: #e5e7eb;
        }
        main {
            max-width: 900px;
            margin: 16px auto;
            padding: 16px;
        }
        h1 {
            margin: 0 0 4px;
            font-size: 20px;
        }
        h2 {
            margin: 12px 0 8px;
            font-size: 16px;
        }
        p {
            margin: 4px 0 8px;
            font-size: 14px;
        }
        code {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 12px;
            background: #020617;
            padding: 1px 4px;
            border-radius: 3px;
        }
        section {
            margin-bottom: 18px;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #1e293b;
            background: #020617;
        }
        label {
            display: block;
            font-size: 13px;
            margin-bottom: 3px;
        }
        input, textarea {
            width: 100%;
            padding: 6px 8px;
            border-radius: 4px;
            border: 1px solid #1f2937;
            background: #020617;
            color: #e5e7eb;
            font-size: 13px;
            box-sizing: border-box;
        }
        input:focus, textarea:focus {
            outline: none;
            border-color: #38bdf8;
        }
        textarea {
            min-height: 60px;
        }
        .row {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 8px;
        }
        @media (max-width: 768px) {
            .row {
                grid-template-columns: minmax(0, 1fr);
            }
        }
        button {
            padding: 6px 10px;
            border-radius: 4px;
            border: 1px solid transparent;
            background: #38bdf8;
            color: #020617;
            font-size: 13px;
            cursor: pointer;
        }
        button.secondary {
            background: #020617;
            color: #e5e7eb;
            border-color: #4b5563;
        }
        button.small {
            padding: 4px 8px;
            font-size: 12px;
        }
        button + button {
            margin-left: 6px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            margin-top: 8px;
        }
        th, td {
            padding: 6px 8px;
            border: 1px solid #1e293b;
            text-align: left;
        }
        th {
            background: #020617;
            font-weight: 500;
        }
        .status {
            margin-top: 6px;
            font-size: 12px;
            color: #9ca3af;
        }
        .mono {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }
        .oauth-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
            gap: 8px;
        }
        .oauth-card {
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #1e293b;
            background: #020617;
        }
        .oauth-card h3 {
            margin: 0 0 4px;
            font-size: 14px;
        }
        .oauth-card p {
            font-size: 12px;
            margin: 2px 0 6px;
        }
        .oauth-row {
            display: grid;
            grid-template-columns: minmax(0, 1.5fr) auto auto;
            gap: 4px;
            align-items: center;
        }
        @media (max-width: 768px) {
            .oauth-row {
                grid-template-columns: minmax(0, 1fr);
            }
        }
        .oauth-status {
            margin-top: 4px;
            font-size: 12px;
            color: #9ca3af;
        }
    </style>
</head>
<body>
<main>
    <h1>HelixRun credentials</h1>
    <p>
        Manage provider API keys via <code>/api/credentials</code> and start OAuth/device flows that are handled
        by the embedded CLIProxyAPI management API under <code>/cliproxy/v0/management</code>.
    </p>

    <section>
        <h2>Configuration</h2>
        <p>
            Paste the local management password, if required. It is stored
            only in this browser (localStorage) and sent as <code>X-Management-Key</code>
            on requests to the CLIProxy management API.
        </p>
        <div class="row">
            <div>
                <label for="management-key">Local management password</label>
                <input id="management-key" type="password" autocomplete="off"
                       placeholder="LOCAL_MANAGEMENT_PASSWORD or MANAGEMENT_PASSWORD">
            </div>
            <div>
                <label for="credentials-base">Credential API base (unused)</label>
                <input id="credentials-base" type="text" value="/api/credentials" autocomplete="off">
            </div>
        </div>
        <div class="row" style="margin-top:8px;">
            <div>
                <label for="management-base">CLIProxy management base</label>
                <input id="management-base" type="text" value="/cliproxy/v0/management" autocomplete="off">
            </div>
            <div style="padding-top:20px;">
                <button id="save-config-btn">Save config</button>
                <button id="clear-config-btn" class="secondary">Clear</button>
            </div>
        </div>
        <div class="status" id="config-status"></div>
    </section>

    <section>
        <h2>Create API key credential</h2>
        <form id="create-credential-form">
            <div class="row">
                <div>
                    <label for="provider-input">Provider (required)</label>
                    <input id="provider-input" type="text" placeholder="gemini, openai, anthropic, ..." required>
                </div>
                <div>
                    <label for="label-input">Label</label>
                    <input id="label-input" type="text" placeholder="Optional human label">
                </div>
            </div>
            <div class="row" style="margin-top:8px;">
                <div>
                    <label for="api-key-input">API key (required)</label>
                    <input id="api-key-input" type="password" autocomplete="off" placeholder="sk-..." required>
                </div>
                <div>
                    <label for="project-id-input">Project / tenant</label>
                    <input id="project-id-input" type="text" placeholder="Optional provider-specific project id">
                </div>
            </div>
            <div style="margin-top:8px;">
                <label for="metadata-input">Additional metadata (JSON, optional)</label>
                <textarea id="metadata-input" placeholder='{"region":"us","note":"optional"}'></textarea>
            </div>
            <div style="margin-top:8px;">
                <button type="submit">Save credential</button>
                <button type="button" id="reset-form-btn" class="secondary">Reset</button>
            </div>
            <div class="status" id="create-status"></div>
        </form>
    </section>

    <section>
        <h2>Stored credentials</h2>
        <button id="refresh-credentials-btn" class="secondary">Refresh</button>
        <table>
            <thead>
            <tr>
                <th>Provider</th>
                <th>Label</th>
                <th>ID</th>
                <th>Status</th>
                <th>Updated</th>
                <th></th>
            </tr>
            </thead>
            <tbody id="credentials-body">
            <tr>
                <td colspan="6">No credentials loaded.</td>
            </tr>
            </tbody>
        </table>
        <div class="status" id="credentials-status"></div>
    </section>

    <section>
        <h2>Provider OAuth / device-flow logins</h2>
        <p>
            These buttons call the CLIProxy management API via <code>/cliproxy/v0/management</code> to start login flows.
            When a flow completes, CLIProxy writes an auth file into its <code>auth-dir</code>; the shared store mirrors
            that file into the <code>provider_credentials</code> table so it appears in the list above.
        </p>
        <div class="oauth-grid">
            <div class="oauth-card" data-provider="codex">
                <h3>Codex</h3>
                <p>Start the Codex OAuth flow.</p>
                <div class="oauth-row">
                    <input id="codex-oauth-url" type="text" readonly placeholder="Authorization URL will appear here">
                    <button type="button" class="small" data-oauth-start="codex">Start</button>
                    <button type="button" class="secondary small" data-oauth-open="codex">Open</button>
                </div>
                <div class="oauth-status" id="codex-oauth-status"></div>
            </div>
            <div class="oauth-card" data-provider="anthropic">
                <h3>Anthropic (Claude)</h3>
                <p>Start the Anthropic OAuth flow.</p>
                <div class="oauth-row">
                    <input id="anthropic-oauth-url" type="text" readonly placeholder="Authorization URL will appear here">
                    <button type="button" class="small" data-oauth-start="anthropic">Start</button>
                    <button type="button" class="secondary small" data-oauth-open="anthropic">Open</button>
                </div>
                <div class="oauth-status" id="anthropic-oauth-status"></div>
            </div>
            <div class="oauth-card" data-provider="antigravity">
                <h3>Antigravity (Google)</h3>
                <p>Start the Antigravity OAuth flow.</p>
                <div class="oauth-row">
                    <input id="antigravity-oauth-url" type="text" readonly placeholder="Authorization URL will appear here">
                    <button type="button" class="small" data-oauth-start="antigravity">Start</button>
                    <button type="button" class="secondary small" data-oauth-open="antigravity">Open</button>
                </div>
                <div class="oauth-status" id="antigravity-oauth-status"></div>
            </div>
            <div class="oauth-card" data-provider="gemini-cli">
                <h3>Gemini CLI</h3>
                <p>Start the Gemini CLI OAuth/device flow.</p>
                <div class="oauth-row">
                    <input id="gemini-cli-oauth-url" type="text" readonly placeholder="Authorization URL will appear here">
                    <button type="button" class="small" data-oauth-start="gemini-cli">Start</button>
                    <button type="button" class="secondary small" data-oauth-open="gemini-cli">Open</button>
                </div>
                <div class="oauth-status" id="gemini-cli-oauth-status"></div>
            </div>
            <div class="oauth-card" data-provider="qwen">
                <h3>Qwen</h3>
                <p>Start the Qwen device-flow login.</p>
                <div class="oauth-row">
                    <input id="qwen-oauth-url" type="text" readonly placeholder="Authorization URL will appear here">
                    <button type="button" class="small" data-oauth-start="qwen">Start</button>
                    <button type="button" class="secondary small" data-oauth-open="qwen">Open</button>
                </div>
                <div class="oauth-status" id="qwen-oauth-status"></div>
            </div>
            <div class="oauth-card" data-provider="copilot">
                <h3>GitHub Copilot</h3>
                <p>
                    Start the GitHub OAuth flow used by CLIProxy for Copilot. When the flow finishes, Copilot auth
                    files are written into the shared <code>auth-dir</code> and mirrored into the credential database.
                </p>
                <div class="oauth-row">
                    <input id="copilot-oauth-url" type="text" readonly placeholder="Authorization URL will appear here">
                    <button type="button" class="small" data-oauth-start="copilot">Start</button>
                    <button type="button" class="secondary small" data-oauth-open="copilot">Open</button>
                </div>
                <div class="oauth-status" id="copilot-oauth-status"></div>
            </div>
        </div>
    </section>
</main>

<script>
    (function () {
        var STORAGE_KEY_MANAGEMENT = "helixrun_management_key";
        var STORAGE_KEY_MGMT_BASE = "helixrun_management_base";

        var managementKeyInput = document.getElementById("management-key");
        var credentialsBaseInput = document.getElementById("credentials-base");
        var managementBaseInput = document.getElementById("management-base");
        var configStatus = document.getElementById("config-status");

        function loadConfig() {
            try {
                var mk = localStorage.getItem(STORAGE_KEY_MANAGEMENT) || "";
                var mb = localStorage.getItem(STORAGE_KEY_MGMT_BASE) || "";
                if (mk) managementKeyInput.value = mk;
                if (mb) managementBaseInput.value = mb;
                configStatus.textContent = "Config is stored only in this browser.";
            } catch (e) {
                configStatus.textContent = "Failed to load stored config: " + e.message;
            }
        }

        function saveConfig() {
            try {
                localStorage.setItem(STORAGE_KEY_MANAGEMENT, managementKeyInput.value || "");
                localStorage.setItem(STORAGE_KEY_MGMT_BASE, managementBaseInput.value || "/cliproxy/v0/management");
                configStatus.textContent = "Config saved.";
            } catch (e) {
                configStatus.textContent = "Failed to save config: " + e.message;
            }
        }

        function clearConfig() {
            try {
                localStorage.removeItem(STORAGE_KEY_MANAGEMENT);
                localStorage.removeItem(STORAGE_KEY_MGMT_BASE);
            } catch (e) {
                // ignore
            }
            managementKeyInput.value = "";
            managementBaseInput.value = "/cliproxy/v0/management";
            configStatus.textContent = "Config cleared.";
        }

        document.getElementById("save-config-btn").addEventListener("click", saveConfig);
        document.getElementById("clear-config-btn").addEventListener("click", clearConfig);

        function managementApiUrl(path) {
            var base = (managementBaseInput.value || "/cliproxy/v0/management").trim();
            if (base.endsWith("/")) base = base.slice(0, -1);
            if (path && !path.startsWith("/")) path = "/" + path;
            return base + (path || "");
        }

        async function requestAuth(path, options) {
            var opts = options || {};
            var headers = opts.headers || {};
            var key = (managementKeyInput.value || "").trim();
            if (key) {
                headers["X-Management-Key"] = key;
            }
            if (!headers["Content-Type"] && opts.body && typeof opts.body === "string") {
                headers["Content-Type"] = "application/json";
            }
            var res = await fetch(managementApiUrl(path), Object.assign({}, opts, { headers: headers }));
            if (res.status === 204) {
                return null;
            }
            if (!res.ok) {
                var msg = "HTTP " + res.status;
                try {
                    var data = await res.json();
                    if (data && data.error) msg = data.error;
                } catch (_) {}
                throw new Error(msg);
            }
            try {
                return await res.json();
            } catch (_) {
                return null;
            }
        }

        var credentialsBody = document.getElementById("credentials-body");
        var credentialsStatus = document.getElementById("credentials-status");

        function renderCredentials(list) {
            while (credentialsBody.firstChild) {
                credentialsBody.removeChild(credentialsBody.firstChild);
            }
            if (!list || !list.length) {
                var row = document.createElement("tr");
                var cell = document.createElement("td");
                cell.colSpan = 6;
                cell.textContent = "No credentials found.";
                row.appendChild(cell);
                credentialsBody.appendChild(row);
                return;
            }
            list.forEach(function (cred) {
                var row = document.createElement("tr");
                function add(text, cls) {
                    var td = document.createElement("td");
                    td.textContent = text || "";
                    if (cls) td.className = cls;
                    row.appendChild(td);
                }
                add(cred.provider, "mono");
                add(cred.label || "", "");
                add(cred.id || "", "mono");
                add(cred.status || "", "");
                var updated = "";
                if (cred.updated_at) {
                    try {
                        updated = new Date(cred.updated_at).toLocaleString();
                    } catch (_) {
                        updated = String(cred.updated_at);
                    }
                }
                add(updated, "");
                var td = document.createElement("td");
                var btn = document.createElement("button");
                btn.textContent = "Delete";
                btn.className = "small secondary";
                btn.addEventListener("click", function () {
                    if (!cred.id) return;
                    if (!window.confirm("Delete credential \"" + cred.id + "\"?")) return;
                    deleteCredential(cred.id);
                });
                td.appendChild(btn);
                row.appendChild(td);
                credentialsBody.appendChild(row);
            });
        }

        async function loadCredentials() {
            credentialsStatus.textContent = "Loading credentials...";
            try {
                var data = await requestAuth("/auth-files", { method: "GET" });
                var files = (data && data.files) || [];
                var list = files.map(function (f) {
                    return {
                        provider: f.type || "",
                        label: f.email || "",
                        id: f.name || "",
                        status: "",
                        updated_at: f.modtime || ""
                    };
                });
                renderCredentials(list);
                credentialsStatus.textContent = "Loaded " + list.length + " credential(s).";
            } catch (e) {
                credentialsStatus.textContent = "Failed to load credentials: " + e.message;
            }
        }

        async function deleteCredential(id) {
            credentialsStatus.textContent = "Deleting credential...";
            try {
                await requestAuth("/auth-files?name=" + encodeURIComponent(id), { method: "DELETE" });
                credentialsStatus.textContent = "Credential deleted.";
                await loadCredentials();
            } catch (e) {
                credentialsStatus.textContent = "Failed to delete credential: " + e.message;
            }
        }

        document.getElementById("refresh-credentials-btn").addEventListener("click", loadCredentials);

        var createForm = document.getElementById("create-credential-form");
        var createStatus = document.getElementById("create-status");

        document.getElementById("reset-form-btn").addEventListener("click", function () {
            createForm.reset();
            createStatus.textContent = "";
        });

        createForm.addEventListener("submit", function (e) {
            e.preventDefault();
            createStatus.textContent = "";
            var provider = (document.getElementById("provider-input").value || "").trim();
            var label = (document.getElementById("label-input").value || "").trim();
            var apiKey = (document.getElementById("api-key-input").value || "").trim();
            var projectId = (document.getElementById("project-id-input").value || "").trim();
            var metadataRaw = (document.getElementById("metadata-input").value || "").trim();
            if (!provider) {
                createStatus.textContent = "Provider is required.";
                return;
            }
            if (!apiKey) {
                createStatus.textContent = "API key is required.";
                return;
            }
            var metadata = {};
            if (projectId) metadata.project_id = projectId;
            if (metadataRaw) {
                try {
                    var extra = JSON.parse(metadataRaw);
                    if (extra && typeof extra === "object") {
                        Object.keys(extra).forEach(function (k) {
                            metadata[k] = extra[k];
                        });
                    }
                } catch (err) {
                    createStatus.textContent = "Metadata must be valid JSON: " + err.message;
                    return;
                }
            }
            var fileName = provider.toLowerCase() + "-" + Date.now() + ".json";
            var filePayload = Object.assign({}, metadata, {
                type: provider,
                api_key: apiKey,
                label: label
            });
            createStatus.textContent = "Saving credential via /auth-files...";
            requestAuth("/auth-files?name=" + encodeURIComponent(fileName), {
                method: "POST",
                body: JSON.stringify(filePayload)
            }).then(function () {
                createStatus.textContent = "Credential saved.";
                createForm.reset();
                loadCredentials();
            }).catch(function (err) {
                createStatus.textContent = "Failed to save credential: " + err.message;
            });
        });

        var oauthConfig = [
            { id: "codex", startEndpoint: "/codex-auth-url?is_webui=1" },
            { id: "anthropic", startEndpoint: "/anthropic-auth-url?is_webui=1" },
            { id: "antigravity", startEndpoint: "/antigravity-auth-url?is_webui=1" },
            { id: "gemini-cli", startEndpoint: "/gemini-cli-auth-url?is_webui=1" },
            { id: "qwen", startEndpoint: "/qwen-auth-url?is_webui=1" },
            // GitHub Copilot device-flow entrypoint (POST).
            { id: "copilot", startEndpoint: "/github-copilot/token" }
        ];

        function extractState(url) {
            try {
                var u = new URL(url);
                return u.searchParams.get("state");
            } catch (_) {
                return null;
            }
        }

        function setOAuthStatus(id, text) {
            var el = document.getElementById(id + "-oauth-status");
            if (!el) return;
            el.textContent = text || "";
        }

        function startPolling(providerId, state) {
            if (!state) {
                setOAuthStatus(providerId, "Missing state parameter in OAuth URL.");
                return;
            }
            var start = Date.now();
            var interval = 2000;
            var maxMs = 5 * 60 * 1000;
            function tick() {
                if (Date.now() - start > maxMs) {
                    setOAuthStatus(providerId, "Timed out waiting for OAuth completion.");
                    return;
                }
                fetch(managementApiUrl("/get-auth-status?state=" + encodeURIComponent(state)), { method: "GET" })
                    .then(function (res) {
                        if (!res.ok) throw new Error("HTTP " + res.status);
                        return res.json();
                    })
                    .then(function (data) {
                        var status = data && data.status;
                        if (status === "ok") {
                            setOAuthStatus(providerId, "Login completed. Reloading credentials.");
                            loadCredentials();
                        } else if (status === "error") {
                            setOAuthStatus(providerId, "Login failed: " + (data.error || "unknown error"));
                        } else if (status === "wait") {
                            setOAuthStatus(providerId, "Waiting for authorization...");
                            setTimeout(tick, interval);
                        } else {
                            setOAuthStatus(providerId, "Unexpected status: " + status);
                        }
                    })
                    .catch(function (err) {
                        setOAuthStatus(providerId, "Error while polling: " + err.message);
                    });
            }
            setTimeout(tick, interval);
        }

        function attachOAuthHandlers() {
            oauthConfig.forEach(function (cfg) {
                var startBtn = document.querySelector('[data-oauth-start="' + cfg.id + '"]');
                var openBtn = document.querySelector('[data-oauth-open="' + cfg.id + '"]');
                var urlInput = document.getElementById(cfg.id + "-oauth-url");
                if (!startBtn || !openBtn || !urlInput) return;
                startBtn.addEventListener("click", function () {
                    setOAuthStatus(cfg.id, "Starting OAuth flow...");
                    urlInput.value = "";
                    var isCopilot = cfg.id === "copilot";
                    var reqOptions = { method: isCopilot ? "POST" : "GET" };
                    fetch(managementApiUrl(cfg.startEndpoint), reqOptions)
                        .then(function (res) {
                            if (!res.ok) throw new Error("HTTP " + res.status);
                            return res.json();
                        })
                        .then(function (data) {
                            if (cfg.id === "copilot") {
                                if (!data || data.status !== "ok") {
                                    throw new Error((data && data.error) || "Unexpected response");
                                }
                                var verificationUri = data.verification_uri || data.verification_uri_complete || "";
                                var userCode = data.user_code || "";
                                var state = data.state || "";
                                urlInput.value = verificationUri;
                                var msg = "Open " + verificationUri + " and enter code " + userCode + ".";
                                setOAuthStatus(cfg.id, msg);
                                try { if (verificationUri) window.open(verificationUri, "_blank", "noopener"); } catch (_) {}
                                startPolling(cfg.id, state);
                                return;
                            }
                            var authUrl = data && data.url;
                            if (!authUrl) throw new Error("Missing url in response");
                            urlInput.value = authUrl;
                            setOAuthStatus(cfg.id, "Waiting for authorization...");
                            try { window.open(authUrl, "_blank", "noopener"); } catch (_) {}
                            startPolling(cfg.id, extractState(authUrl));
                        })
                        .catch(function (err) {
                            setOAuthStatus(cfg.id, "Failed to start OAuth: " + err.message);
                        });
                });
                openBtn.addEventListener("click", function () {
                    if (!urlInput.value) return;
                    try { window.open(urlInput.value, "_blank", "noopener"); } catch (_) {}
                });
            });
        }

        loadConfig();
        attachOAuthHandlers();
        loadCredentials();
    })();
</script>
</body>
</html>
